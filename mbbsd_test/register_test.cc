#include <gtest/gtest.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include "bbs.h"
#include "testutil.h"
#include "testmock.h"
#include "mbbsd_s.c"

// accept-user-aggrement
class RegisterTest : public ::testing::Test {
 protected:
  void SetUp() override {
    system("echo \"(start) pwd:\" && pwd");
    fprintf(stderr, "BBSHOME: " BBSHOME "\n");

    system("mkdir -p " BBSHOME);
    system("rm -r " BBSHOME "/home");
    system("rm -r " BBSHOME "/etc");
    system("rm  " BBSHOME "/.PASSWDS");
    system("rm " BBSHOME "/.BRD");

    system("cp -R ./testcase/home1 " BBSHOME "/home");
    system("cp -R ./testcase/etc " BBSHOME "/etc");
    system("cp -R ./testcase/etc1 " BBSHOME "/etc1");
    system("cp ./testcase/.PASSWDS1 " BBSHOME "/.PASSWDS");
    system("cp ./testcase/.BRD1 " BBSHOME "/.BRD");
    system("echo \"pwd:\" && pwd");

    // chdir
    chdir(BBSHOME);
    system("echo \"(after chdir BBSHOME) pwd:\" && pwd");
    setup_root_link((char *)BBSHOME);
    system("echo \"(after setup_root_link BBSHOME) pwd:\" && pwd");
    typeahead(TYPEAHEAD_NONE);

    // load uhash
    load_uhash();

    // init scr / io
    initscr();
    if(vin.buf == NULL) {
      init_io();
    }
  }

  void TearDown() override {
    // reset scr / io
    reset_oflush_buf();

    // chdir
    chdir(pwd_path);
  }

  char pwd_path[TEST_BUFFER_SIZE];
};

TEST_F(RegisterTest, EnsureUserAgreementVerion) {
  char buf[20] = {};
  sprintf(buf, "  y\r\n");
  put_vin((unsigned char *)buf, strlen(buf));

  // load SYSOP2
  load_current_user("SYSOP2");
  fprintf(stderr, "[register_test] after load current_user\n");

  put_vin((unsigned char *)buf, strlen(buf));

  system("rm -r " BBSHOME "/etc");
  system("cp -R " BBSHOME "/etc1 " BBSHOME "/etc");

  ensure_user_agreement_version();

  // refresh is in empty pvin, which never happened in test.
  // we need to manually do refresh to get the OFLUSH_BUF.
  refresh();
  log_oflush_buf();

  char expected[] = "\x1B\x5B\x48\x1B\x5B\x4A" //\x1b[H\x1bJ (clearbuf)
      "\x1B\x5B\x32\x34\x3B\x31\x48" //\x1b[24;1H
      "\x1B\x5B\x31\x3B\x33\x36\x3B\x34\x34\x6D" //\x1b[1;36;44m
      "\x20\xA1\xBB\x20\xA8\xCF\xA5\xCE\xAA\xCC" // ◆ 使用者
      "\xB1\xF8\xB4\xDA\xA4\x77\xB8\x67\xA7\xF3" //條款已經更
      "\xB7\x73\x2C\x20\xBD\xD0\xAD\xAB\xB7\x73" //新, 請重新
      "\xC0\xCB\xB5\xF8\x2E\x20\x20\x20\x20\x20" //檢視.
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //
      "\x20\x20\x20" //
      "\x1B\x5B\x31\x3B\x33\x33\x3B\x34\x36\x6D" //\x1b[1;33;46m
      "\x20\x5B\xAB\xF6\xA5\xF4\xB7\x4E\xC1\xE4" // [按任意鍵
      "\xC4\x7E\xC4\xF2\x5D\x20" //繼續]
      "\x1B\x5B\x6D" //\x1b[m
      "\x1B\x5B\x48\x1B\x5B\x4A" //\x1b[H\x1bJ (clearbuf)
      "\x54\x68\x69\x73\x20\x69\x73\x20\x75\x73" //This is us
      "\x65\x72\x20\x61\x67\x72\x65\x65\x6D\x65" //er agreeme
      "\x6E\x74" //nt
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x6D" //\x1b[m
      "\x1B\x5B\x33\x37\x3B\x34\x34\x6D" //\x1b[37;44m
      "\x20\x20\xC2\x73\xC4\xFD\x20\xB2\xC4\x20" //  瀏覽 第
      "\x31\x2F\x31\x20\xAD\xB6\x20\x28\x31\x30" //1/1 頁 (10
      "\x30\x25\x29\x20" //0%)
      "\x1B\x5B\x31\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[1;30;47m
      "\x20\xA5\xD8\xAB\x65\xC5\xE3" // 目前顯
      "\xA5\xDC\x3A\x20\xB2\xC4\x20\x30\x31\x7E" //示: 第 01~
      "\x30\x31\x20\xA6\xE6" //01 行
      "\x1B\x5B\x30\x3B\x34\x37\x6D" //\x1b[0;47m
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20"
      "\x1B\x5B\x33\x31\x6D" //\x1b[31m
      "\x28\x68\x29"//(h)
      "\x1B\x5B\x33\x30\x6D" //\x1b[30m
      "\xBB\xA1\xA9\xFA\x20" //說明
      "\x1B\x5B\x33\x31\x6D" //\x1b[31m
      "\x28\xA1\xF6\x2F\x71\x29" //(←/q)
      "\x1B\x5B\x33\x30\x6D" //\x1b[30m
      "\xC2\xF7\xB6\x7D\x20" //離開
      "\x1B\x5B\x6D\x1B\x5B\x4B\x0D" //\x1b[m\x1b[K
      "\xBD\xD0\xB0\xDD\xB1\x7A\xB1\xB5\xA8\xFC" //請問您接受
      "\xB3\x6F\xA5\xF7\xA8\xCF\xA5\xCE\xAA\xCC" //這份使用者
      "\xB1\xF8\xB4\xDA\xB6\xDC\x3F\x20\x28\x79" //條款嗎? (y
      "\x65\x73\x2F\x6E\x6F\x29\x20" //es/no)
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x20"
      "\x1B\x5B\x6D" //\x1b[m
      "\x1B\x5B\x4B\x1B\x5B\x32\x34\x3B\x33\x38\x48\x0D" //\x1b[K\x1b[24;38H
      "\xBD\xD0\xB0\xDD\xB1\x7A\xB1\xB5\xA8\xFC\xB3\x6F" //請問您接受這
      "\xA5\xF7\xA8\xCF\xA5\xCE\xAA\xCC\xB1\xF8\xB4\xDA" //份使用者條款
      "\xB6\xDC\x3F\x20\x28\x79\x65\x73\x2F\x6E\x6F\x29\x20" //嗎? (yes/no)
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x79\x20\x20" //y
      "\x1B\x5B\x6D" //\x1b[m
      "\x1B\x5B\x32\x34\x3B\x33\x39\x48\x0D" //\x1b[24;39H
      "\x1B\x5B\x31\x3B\x33\x36\x3B\x34\x34\x6D" //\x1b[1;36;44m
      "\x20\xA1\xBB\x20\xA8\xCF\xA5\xCE\xAA\xCC" // ◆ 使用者
      "\xB1\xF8\xB4\xDA\xA4\x77\xB8\x67\xA7\xF3" //條款已經更
      "\xB7\x73\x2C\x20\xBD\xD0\xAD\xAB\xB7\x73" //新, 請重新
      "\xC0\xCB\xB5\xF8\x2E\x20\x20\x20\x20\x20" //檢視.
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //
      "\x20\x20\x20" //
      "\x1B\x5B\x31\x3B\x33\x33\x3B\x34\x36\x6D" //\x1b[1;33;46m
      "\x20\x5B\xAB\xF6\xA5\xF4\xB7\x4E\xC1\xE4" // [按任意鍵
      "\xC4\x7E\xC4\xF2\x5D\x20" //繼續]
      "\x1B\x5B\x6D\x1B\x5B\x48\x1B\x5B\x4A" //\x1b[m\x1b[H\x1b[J (clearbuf)
      "\x54\x68\x69\x73\x20\x69\x73\x20\x75\x73\x65" //This is use
      "\x72\x20\x61\x67\x72\x65\x65\x6D\x65\x6E\x74" //r agreement
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x4B\x0A\x0D" //\x1b[K
      "\x1B\x5B\x6D\x1B\x5B\x33\x37\x3B\x34\x34\x6D" //\x1b[m\x1b[37;44m
      "\x20\x20\xC2\x73\xC4\xFD\x20\xB2\xC4\x20\x31" //  瀏覽 第 1
      "\x2F\x31\x20\xAD\xB6\x20\x28\x31\x30\x30\x25\x29\x20" ///1 頁 (100%)
      "\x1B\x5B\x31\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[1;30;47m
      "\x20\xA5\xD8\xAB\x65\xC5\xE3\xA5\xDC\x3A\x20\xB2\xC4" // 目前顯示: 第
      "\x20\x30\x31\x7E\x30\x31\x20\xA6\xE6"// 01~01 行
      "\x1B\x5B\x30\x3B\x34\x37\x6D" //\x1b[0;47m
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x33\x31\x6D" //\x1b[31m
      "\x28\x68\x29" //(h)
      "\x1B\x5B\x33\x30\x6D" //\x1b[30m
      "\xBB\xA1\xA9\xFA\x20" //說明
      "\x1B\x5B\x33\x31\x6D" //\x1b[31m
      "\x28\xA1\xF6\x2F\x71\x29" //(←/q)
      "\x1B\x5B\x33\x30\x6D" //\x1b[30m
      "\xC2\xF7\xB6\x7D\x20" //離開
      "\x1B\x5B\x6D\x1B\x5B\x4B\x0D" //\x1b[m\x1b[K
      "\xBD\xD0\xB0\xDD\xB1\x7A\xB1\xB5\xA8\xFC" //請問您接受
      "\xB3\x6F\xA5\xF7\xA8\xCF\xA5\xCE\xAA\xCC" //這份使用者
      "\xB1\xF8\xB4\xDA\xB6\xDC\x3F\x20\x28\x79" //條款嗎? (y
      "\x65\x73\x2F\x6E\x6F\x29\x20" //es/no)
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x4B\x1B\x5B\x32\x34\x3B\x33\x38\x48\x0D" //\x1b[m\x1b[K\x1b24;38K
      "\xBD\xD0\xB0\xDD\xB1\x7A\xB1\xB5\xA8\xFC\xB3\x6F\xA5\xF7\xA8\xCF" //請問您接受這份使
      "\xA5\xCE\xAA\xCC\xB1\xF8\xB4\xDA\xB6\xDC\x3F\x20\x28\x79\x65\x73" //用者條款嗎? (yes
      "\x2F\x6E\x6F\x29\x20" ///no)
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x79\x20\x20" //y
      "\x1B\x5B\x6D\x1B\x5B\x32\x34\x3B\x33\x39\x48\x0D" //\x1b[m\x1b[24;39K
      "\0";

  EXPECT_STREQ((char *)OFLUSH_BUF, (char *)expected);
}
