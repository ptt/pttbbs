#include "register_test.h"

TEST_F(RegisterTest, QueryAdbannerUsongPrefChanged) {
  char buf[20] = {};
  sprintf(buf, "  y\r\n");
  put_vin((unsigned char *)buf, strlen(buf));

  // load SYSOP2
  load_current_user("SYSOP2");
  fprintf(stderr, "[register_test4] after load current_user: UF_ADBANNER: %d UF_ADBANNER_USONG: %d\n", cuser.uflag & UF_ADBANNER, cuser.uflag & UF_ADBANNER_USONG);

  refresh();
  log_oflush_buf();
  reset_oflush_buf();

  sprintf(buf, "u\r\n");
  put_vin((unsigned char *)buf, strlen(buf));

  int ret = query_adbanner_usong_pref_changed(&cuser, 0);

  EXPECT_EQ(ret, 1);

  refresh();
  log_oflush_buf();

  unsigned char expected[] = ""
      "\x1B[H\x1B[J"
      "\x1B[1;37;46m\xA1i \xB0\xCA\xBA" "A\xAC\xDD\xAAO\xA4\xDF\xB1\xA1\xC2I\xBC\xBD\xC5\xE3\xA5\xDC\xB3]\xA9w \xA1j\x1B[m\n\r" //【 動態看板心情點播顯示設定 】
      " \xA2z\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2{\n\r" // ┌─────────────────────────────────────┐
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2x     \xA6" "b\xA8\xCF\xA5\xCE BBS \xAA\xBA\xB9L\xB5{\xA4\xA4\xA1" "A\xB1z\xA5i\xAF\xE0\xB7|\xA6" "b\xB5" "e\xAD\xB1\xA4W\xA4\xE8\xA6\xB9\xB0\xCF\xAC\xDD\xA8\xEC\xA4@\xA8\xC7\xB0\xCA\xBA" "A\xAA\xBA\xB0T\xAE\xA7\xA7i\xA5\xDC\xA1" "A  \xA2x\n\r" //│     在使用 BBS 的過程中，您可能會在畫面上方此區看到一些動態的訊息告示，  │
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2x     \xA8\xE4\xA4\xBA\xAE" "e\xB6}\xA9\xF1\xB5\xB9\xA6U\xA8\xCF\xA5\xCE\xAA\xCC\xBBP\xA4\xBD\xAFq\xB9\xCE\xC5\xE9\xA5\xD3\xBD\xD0\xA1" "A\xA9\xD2\xA5H\xB7|\xA5]\xA7t\xAB" "D\xB0\xD3\xB7~\xAA\xBA\xAC\xA1\xB0\xCA\xB8\xEA\xB0T/\xBA\xF4\xAB\xC5\xA1" "A\xA2x\n\r" // │     其內容開放給各使用者與公益團體申請，所以會包含非商業的活動資訊/網宣，│
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2x     \xC1\xD9\xA6\xB3\xA8\xD3\xA6\xDB\xA6U\xA8\xCF\xA5\xCE\xAA\xCC\xAA\xBA\xA4\xDF\xB1\xA1\xC2I\xBC\xBD (\xA5i\xAF\xE0\xA5]\xA7t\xB8\xD3\xA8\xCF\xA5\xCE\xAA\xCC\xAA\xBA\xAC" "F\xAAv\xA9\xCA\xA8\xA5\xBD\xD7\xA9\xCE\xA6U\xBA\xD8\xAF" "d\xA8\xA5)\xA1" "C\xA2x\n\r" // │     還有來自各使用者的心情點播 (可能包含該使用者的政治性言論或各種留言)。│
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2x                                                                          \xA2x\n\r" // │                                                                          │
      " \xA2|\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2w\xA2}" // └─────────────────────────────────────┘
      "\x1B[14;1H        "
      "\x1B[1m\xA6\xB9\xC3\xFE\xA5\xD1\xA8\xCF\xA5\xCE\xAA\xCC\xA6\xDB\xA6\xE6\xB5o\xAA\xED\xAA\xBA\xA4\xE5\xA6r\xBBP\xB9\xCF\xB9\xB3\xA8\xC3\xA4\xA3\xA5N\xAA\xED\xAF\xB8\xA4\xE8\xA5\xDF\xB3\xF5\xA1" "C" //此類由使用者自行發表的文字與圖像並不代表站方立場。
      "\x1B[m\x1B[16;1H        "
      "\xA5\xD1\xA9\xF3\xA4\xDF\xB1\xA1\xC2I\xBC\xBD\xB3\xA1\xA5\xF7\xB8\xFB\xC3\xF8\xA9w\xB8q\xA5X\xA7\xB9\xBE\xE3\xAA\xBA\xBC" "f\xAE\xD6\xBC\xD0\xB7\xC7\xA1" "A\xAC\xB0\xA4" "F\xC1\xD7\xA7K\xB3y\xA6\xA8\xBE\\\xC5\xAA\xAA\xCC\xAA\xBA\xA4\xA3\xA7\xD6\xA9\xCE" //由於心情點播部份較難定義出完整的審核標準，為了避免造成閱讀者的不快或
      "\x1B[18;1H        "
      "\xBB~\xB7|\xA1" "A\xA6" "b\xA6\xB9\xADn\xBDT\xBB{\xB1z\xACO\xA7_\xA7\xC6\xB1\xE6\xC5\xE3\xA5\xDC\xA4\xDF\xB1\xA1\xC2I\xBC\xBD\xA4\xBA\xAE" "e\xA1" "C" //誤會，在此要確認您是否希望顯示心情點播內容。
      "\x1B[20;1H        "
      "(\xADY\xA4\xA7\xAB\xE1\xB7Q\xA7\xEF\xC5\xDC\xA6\xB9\xC3\xFE\xB3]\xA9w\xA1" "A\xA5i\xA6\xDC (U)\xAD\xD3\xA4H\xB3]\xA9w\xB0\xCF->(U)\xAD\xD3\xA4H\xA4\xC6\xB3]\xA9w \xBD\xD5\xBE\xE3)" //(若之後想改變此類設定，可至 (U)個人設定區->(U)個人化設定 調整)
      "\x1B[24;1H"
      "\xBD\xD0\xB0\xDD\xB1z\xA7\xC6\xB1\xE6\xA6" "b\xB0\xCA\xBA" "A\xA7i\xA5\xDC\xB0\xCF\xAC\xDD\xA8\xEC\xA8\xD3\xA6\xDB\xA8\xE4\xA5\xA6\xA8\xCF\xA5\xCE\xAA\xCC\xAA\xBA\xA4\xDF\xB1\xA1\xC2I\xBC\xBD\xB6\xDC? [Y/n]: " //請問您希望在動態告示區看到來自其它使用者的心情點播嗎? [Y/n]:
      "\x1B[0;7m   \x1B[m\x1B[24;62H\r"
      "\xBD\xD0\xB0\xDD\xB1z\xA7\xC6\xB1\xE6\xA6" "b\xB0\xCA\xBA" "A\xA7i\xA5\xDC\xB0\xCF\xAC\xDD\xA8\xEC\xA8\xD3\xA6\xDB\xA8\xE4\xA5\xA6\xA8\xCF\xA5\xCE\xAA\xCC\xAA\xBA\xA4\xDF\xB1\xA1\xC2I\xBC\xBD\xB6\xDC? [Y/n]: " // //請問您希望在動態告示區看到來自其它使用者的心情點播嗎? [Y/n]:
      "\x1B[0;7mu  \x1B[m\x1B[24;63H\r"
      "\0";

  EXPECT_STREQ((char *)OFLUSH_BUF, (char *)expected);
}
