#include "admin_test.h"

TEST_F(AdminTest, MUser) {
  char buf[TEST_BUFFER_SIZE] = {};

  bzero(buf, TEST_BUFFER_SIZE);
  sprintf(buf, "SYSOP\r\na\r\n");
  put_vin((unsigned char *)buf, strlen(buf));

  int ret = m_user();
  EXPECT_EQ(ret, 0);

  refresh();
  log_oflush_buf();

  unsigned char expected[] = "\x1B\x5B\x48\x1B\x5B\x4A" //\x1b[H\x1b[J
      "\x1B\x5B\x31\x3B\x33\x37\x3B\x34\x36\x6D" //\x1b[1;37;46m
      "\xA1\x69\x20\xA8\xCF\xA5\xCE\xAA\xCC\xB3\x5D\xA9\x77\x20\xA1\x6A" //【 使用者設定】
      "\x1B\x5B\x6D\x0A\x0D" //\x1b[0m
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC" //請輸入使用者
      "\xA5\x4E\xB8\xB9\x3A\x20" //代號:
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x31\x39\x48\x0D" //\x1b[m\x1b2;19H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC\xA5\x4E\xB8\xB9\x3A\x20" //請輸入使用者代號:
      ""
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x53\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20" //S
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x32\x30\x48\x0D" //\x1b[m\x1b[2;20H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC\xA5\x4E\xB8\xB9\x3A\x20" //請輸入使用者代號:
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //SY
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x32\x31\x48\x0D" //\x1b[m\\x1b[2;21H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC\xA5\x4E\xB8\xB9\x3A\x20" //請輸入使用者代號:
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //SYS
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x32\x32\x48\x0D" //\x1b[m\x1b[2;22H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC\xA5\x4E\xB8\xB9\x3A\x20" //請輸入使用者代號:
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x32\x33\x48\x0D" //\x1b[m\x1b[2;23H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xA8\xCF\xA5\xCE\xAA\xCC\xA5\x4E\xB8\xB9\x3A\x20" //請輸入使用者代號:
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x50\x20\x20\x20\x20\x20\x20\x20\x20" //SYSO
      "\x1B\x5B\x6D\x1B\x5B\x32\x3B\x32\x34\x48" //\x1b[m\x1b[2;24H
      "\x1B\x5B\x48\x1B\x5B\x4A" //\x1b[H\x1b[J
      "\x1B\x5B\x31\x3B\x33\x37\x3B\x34\x36\x6D" //\x1b[1;37;46m
      "\xA1\x69\x20\xA8\xCF\xA5\xCE\xAA\xCC\xB3\x5D\xA9\x77\x20\xA1\x6A" //【 使用者設定】
      "\x1B\x5B\x6D\x0A\x0D"
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┴┬┴┬┴┬
      "\x1B\x5B\x6D"
      "\x20\x20"
      "\x1B\x5B\x31\x3B\x33\x30\x3B\x34\x35\x6D" //\x1b[1;30;45m
      "\x20\x20\x20\x20\xA8\xCF\x20\xA5\xCE\x20\xAA\xCC\x20\xB8\xEA\x20\xAE\xC6" //    使 用 者 資 料
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D"
      "\x20\x20"
      "\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┴┬┴┬┴┬
      "\x1B\x5B\x6D\x0A\x0D"
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\xA5\x4E\xB8\xB9\xBC\xCA\xBA\xD9\x3A\x20" //代號暱稱:
      "\x53\x59\x53\x4F\x50\x20\x28\xAF\xAB\x29\x0A\x0D" //SYSOP (神)
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x50\x74\x74" //Ptt
      "\xB9\xF4\x3A\x20\x30\x20\x50\x74\x74\xB9\xF4\x0A\x0D" //幣: 0 Ptt幣
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\xAC\x4F\xA7\x5F\xA6\xA8\xA6\x7E\x3A\x20" //是否成年:
      "\xA4\x77\xBA\xA1\x31\x38\xB7\xB3\x0A\x0D" //已滿18歲
      "\x20\x20\x20\x20\x20\x20\x20\x20\xB5\xF9" //註
      "\xA5\x55\xA4\xE9\xB4\xC1\x3A\x20\x30\x39" //冊日期: 09
      "\x2F\x32\x31\x2F\x32\x30\x32\x30\x20\x30" ///21/2020 0
      "\x39\x3A\x34\x31\x3A\x32\x38\x20\x4D\x6F" //9:41:28 Mo
      "\x6E\x20\x28\xA4\x77\xBA\xA1\x20\x36\x32" //n (已滿 62
      "\x39\x20\xA4\xD1\x29\x0A\x0D" //9 天)
      "\x20\x20\x20\x20\x20\x20\x20\x20\xA8\x70\xA4\x48" //私人
      "\xAB\x48\xBD\x63\x3A\x20\x30\x20\xAB\xCA\x20" //信箱: 0 封
      "\x20\x28\xC1\xCA\xB6\x52\xAB\x48\xBD\x63" // (購買信箱
      "\x3A\x20\x30\x20\xAB\xCA\x29\x0A\x0D" //: 0 封)
      "\x20\x20\x20\x20\x20\x20\x20\x20\xA8\xCF" //使
      "\xA5\xCE\xB0\x4F\xBF\xFD\x3A\x20\xB5\x6E" //用記錄: 登
      "\xA4\x4A\xA6\xB8\xBC\xC6\x20\x33\x20\xA6\xB8" //入次數 3 次
      "\x20\x2F\x20\xA4\xE5\xB3\xB9\x20\x30\x20\xBD\x67\x0A\x0D" // / 文章 0 篇
      "\x20\x20\x20\x20\x20\x20\x20\x20\xB3\xCC\xAB\xE1\xA4\x57\xBD\x75" //最後上線
      "\x3A\x20\x30\x36\x2F\x30\x35\x2F\x32\x30" //: 06/05/20
      "\x32\x32\x20\x30\x35\x3A\x32\x30\x3A\x33" //22 05:20:3
      "\x36\x20\x53\x75\x6E\x20\x28\xB1\xBE" //6 Sun (掛
      "\xAF\xB8\xAE\xC9\xA8\x43\xA4\xE9\xBC\x57" //站時每日增
      "\xA5\x5B\x29\x20\x2F\x20\x31\x32\x37\x2E\x30" //加) / 127.0
      "\x2E\x30\x2E\x31\x0A\x0D" //.0.1
      "\x20\x20\x20\x20\x20\x20\x20\x20\xBE\xE1\xA5\xF4\xAA\x4F" //擔任板
      "\xA5\x44\x3A\x20\x0A\x0D" //主:
      "\x20\x20\x20\x20"
      "\x20\x20\x20\x20\xB0\x68\xA4\xE5\xBC\xC6" //    退文數
      "\xA5\xD8\x3A\x20\x30\x0A\x0D" //目: 0
      "\x20\x20\x20"
      "\x20\x20\x20\x20\x20\xA4\x70\x20\xA4\xD1" //小 天
      "\x20\xA8\xCF\x3A\x20\xB5\x4C\x0A\x0D" // 使: 無
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72" //┴┬┴┬┴┬┴
      "\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┬┴┬┴┬
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72" //┴┬┴┬┴
      "\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┬┴┬┴┬
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72"
      "\xA2\x73\xA2\x72\xA2\x73\x1B\x5B\x6D\x0A\x0D" //┬┴┬\x1b[m
      "\xA8\xE4\xA5\xA6\xB8\xEA\xB0\x54\x3A\x20" //其它資訊:
      "\x5B\xA5\xBC\xB5\xF9\xA5\x55\x5D" //[未註冊]
      "\x1B\x5B\x32\x34\x3B\x31\x48\x1B\x5B\x31\x3B\x33\x34\x3B\x34\x34\x6D" //\x1b[24;18H\x1b[1;34;44m
      "\x20\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65" // ▄▄▄▄▄▄▄
      "\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65" //▄▄▄▄▄▄▄▄
      "\x1B\x5B\x31\x3B\x33\x37\x3B\x34\x34\x6D" //\x1b[1;37;44m
      "\x20\xBD\xD0\xAB\xF6\xA5\xF4\xB7\x4E\xC1\xE4\xC4\x7E\xC4\xF2\x20" // 請按任意鍵繼續
      "\x1B\x5B\x31\x3B\x33\x34\x3B\x34\x34\x6D" //\x1b[1;34;44m
      "\xA2\x65\xA2\x65\xA2\x65\xA2\x65" //▄▄▄▄
      "\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65" //▄▄▄▄▄
      "\xA2\x65\xA2\x65\xA2\x65\xA2\x65\xA2\x65" //▄▄▄▄▄
      "\xA2\x65\x20\x20" //▄
      "\x1B\x5B\x6D\x0D\x1B\x5B\x4B" //\x1b[m\x0d\x1b[H
      "\0";

  //char buf[TEST_BUFFER_SIZE] = {};

  bzero(buf, sizeof(buf));
  memcpy(buf, expected + 599, 100);
  fprintf(stderr, "[admin_test2] buf: %s\n", buf);

  // hack for (已滿 629 天)
  // 如果超過 1000 天: 在 expected 加上 \x30. 然後做 hack
  expected[598] = '0';
  expected[599] = '0';
  expected[600] = '0';

  OFLUSH_BUF[598] = '0';
  OFLUSH_BUF[599] = '0';
  OFLUSH_BUF[600] = '0';

  EXPECT_STREQ((char *)OFLUSH_BUF, (char *)expected);
}
