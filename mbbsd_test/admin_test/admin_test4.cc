#include "admin_test.h"

TEST_F(AdminTest, SearchUserBypwd) {
  char buf[TEST_BUFFER_SIZE] = {};

  bzero(buf, TEST_BUFFER_SIZE);
  sprintf(buf, "1\r\nSYSOP10\r\na\r\n0\r\nq\r\n");
  put_vin((unsigned char *)buf, strlen(buf));

  int ret = search_user_bypwd();
  EXPECT_EQ(ret, 0);

  refresh();
  log_oflush_buf();

  unsigned char expected[] =
      "\x1B\x5B\x48\x1B\x5B\x4A"
      "\x1B\x5B\x31\x3B\x33\x37\x3B\x34\x36\x6D"
      "\xA1\x69\x20\xC3\xF6\xC1\xE4\xA6\x72\xB7\x6A\xB4\x4D\x20\xA1\x6A" //【 關鍵字搜尋 】
      "\x1B\x5B\x6D\x0A\x0D"
      "\xB7\x6A\xB4\x4D\xC4\xE6\xA6\xEC\x3A\x20\x5B\x30\x5D" //搜尋欄位: [0]
      "\xA5\xFE\xB3\xA1\x20\x31\x2E\x49\x44\x20" //全部 1.ID
      "\x32\x2E\xA9\x6D\xA6\x57\x20\x33\x2E" //2.姓名 3.
      "\xBC\xCA\xBA\xD9\x20\x34\x2E\xA6\x61\xA7\x7D" //暱稱 4.地址
      "\x20\x35\x2E\x4D\x61\x69\x6C\x20\x36\x2E" //5.Mail 6.
      "\x49\x50\x20\x37\x2E\xC2\xBE\xB7\x7E\x20" //IP 7.職業
      "\x38\x2E\xBB\x7B\xC3\xD2\x0A\x0D" //8.認證
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5B\x61" //[a
      "\x5D\xA4\xA3\xA4\xB9\xB3\x5C\xBB\x7B" //]不允許認
      "\xC3\xD2\xBD\x58\xB5\xF9\xA5\x55\x20\x5B\x62" //證碼註冊 [b
      "\x5D\xB5\xF9\xA5\x55\xAE\xC9\xB6\xA1\x0A\x0D" //]註冊時間
      "\xAD\x6E\xB7\x6A\xB4\x4D\xAD\xFE" //要搜尋哪
      "\xBA\xD8\xB8\xEA\xAE\xC6\xA1\x48" //種資料？
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x1B\x5B\x6D\x1B\x5B\x34\x3B\x31\x37\x48\x0D" //\x1b[m\x1b[4;17H
      "\xAD\x6E\xB7\x6A\xB4\x4D\xAD\xFE\xBA\xD8\xB8\xEA\xAE\xC6\xA1\x48" //要搜尋哪種資料？
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x31\x20" //1
      "\x1B\x5B\x6D\x1B\x5B\x34\x3B\x31\x38\x48\x0A\x0D" //\x1b[m\x1b4;18H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20" //請輸入關鍵字:
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x31\x35\x48\x0D" //\x1b[m\x1b[5;15H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20" //請輸入關鍵字:
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x20\x20\x20\x20" //S
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x31\x36\x48\x0D" //\x1b[m\x1b[5;16H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //SY
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x31\x37\x48\x0D" //\x1b[m\x1b[5;17H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x20\x20\x20\x20\x20\x20" //SYS
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x31\x38\x48\x0D" //\x1b[m\x1b[5;18H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20" //SYSO
      "\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x31\x39\x48\x0D" //\x1b[m\x1b[5;19H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x50\x20\x20\x20\x20\x20\x20\x20\x20" //SYSOP
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x32\x30\x48\x0D" //\x1b[m\x1b[5;20H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x50\x31\x20\x20\x20\x20" //SYSOP1
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x32\x31\x48\x0D" //\x1b[m\x1b[5;21H
      "\xBD\xD0\xBF\xE9\xA4\x4A\xC3\xF6\xC1\xE4\xA6\x72\x3A\x20"
      "\x1B\x5B\x30\x3B\x37\x6D"
      "\x53\x59\x53\x4F\x50\x31\x30" //SYSOP10
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x35\x3B\x32\x32\x48" //\x1b[m\x1b[5;22H
      "\x1B\x5B\x48\x1B\x5B\x4A\x1B\x5B\x31\x3B\x33\x37\x3B\x34\x36\x6D" //\x1b[H\x1b[K\x1b[1;37;46m
      "\xA1\x69\x20\x53\x59\x53\x4F\x50\x31\x30\x20\xA1\x6A" //【 SYSOP10 】
      "\x1B\x5B\x6D\x0A\x0D"
      "\xB2\xC4\x20\x5B\x32\x36\x5D\x20\xB5\xA7" //第 [26] 筆
      "\xB8\xEA\xAE\xC6\x0A\x0D" //資料
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73\x1B\x5B\x6D" //┴┬┴┬┴┬\x1b[m
      "\x20\x20\x1B\x5B\x31\x3B\x33\x30\x3B\x34\x35\x6D" //\x1b[1;30;45m
      "\x20\x20\x20\x20\xA8\xCF\x20\xA5\xCE\x20\xAA\xCC" //    使 用 者
      "\x20\xB8\xEA\x20\xAE\xC6\x20\x20\x20\x20" // 資 料
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x20\x20\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[m  \x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┴┬┴┬┴┬
      "\x1B\x5B\x6D\x0A\x0D"
      "\x20\x20\x20\x20\x20\x20\x20\x20\xA5\x4E\xB8\xB9\xBC\xCA\xBA\xD9\x3A\x20\x53\x59\x53" //        代號暱稱: SYS
      "\x4F\x50\x31\x30\x20\x28\x29\x0A\x0D" //OP10 ()
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x50\x74\x74\xB9\xF4\x3A\x20\x30\x20\x50\x74\x74\xB9\xF4\x0A\x0D" //Ptt幣: 0 Ptt幣
      "\x20\x20\x20\x20\x20\x20\x20\x20\xAC\x4F\xA7\x5F\xA6\xA8" //        是否成
      "\xA6\x7E\x3A\x20\xA4\x77\xBA\xA1\x31\x38\xB7\xB3\x0A\x0D" //年: 已滿18歲
      "\x20\x20\x20\x20\x20\x20\x20\x20\xB5\xF9\xA5\x55\xA4\xE9\xB4\xC1" //        註冊日期
      "\x3A\x20\x30\x31\x2F\x32\x35\x2F\x32\x30" //: 01/25/20
      "\x32\x31\x20\x30\x34\x3A\x31\x37\x3A\x32" //21 04:17:2
      "\x34\x20\x4D\x6F\x6E\x20\x28\xA4\x77" //4 Mon (已
      "\xBA\xA1\x20\x35\x30\x33\x20\xA4\xD1\x29\x0A\x0D" //滿 503 天)
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\xA8\x70\xA4\x48\xAB\x48\xBD\x63\x3A\x20\x30" //私人信箱: 0
      "\x20\xAB\xCA\x20\x20\x28\xC1\xCA\xB6\x52" // 封  (購買
      "\xAB\x48\xBD\x63\x3A\x20\x30\x20\xAB\xCA\x29\x0A\x0D" //信箱: 0 封)
      "\x20\x20\x20\x20\x20\x20\x20\x20\xA8\xCF\xA5\xCE\xB0\x4F\xBF\xFD\x3A" //        使用記錄:
      "\x20\xB5\x6E\xA4\x4A\xA6\xB8\xBC\xC6\x20" // 登入次數
      "\x31\x39\x20\xA6\xB8\x20\x2F\x20\xA4\xE5" //19 次 / 文
      "\xB3\xB9\x20\x30\x20\xBD\x67\x0A\x0D" //章 0 篇
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\xB3\xCC\xAB\xE1\xA4\x57\xBD\x75\x3A\x20\x30\x38\x2F" //最後上線: 08/
      "\x30\x37\x2F\x32\x30\x32\x31\x20\x30\x32" //07/2021 02
      "\x3A\x35\x39\x3A\x34\x38\x20\x53\x61\x74" //:59:48 Sat
      "\x20\x28\xB1\xBE\xAF\xB8\xAE\xC9\xA8\x43" // (掛站時每
      "\xA4\xE9\xBC\x57\xA5\x5B\x29\x20\x2F\x20" //日增加) /
      "\x31\x37\x32\x2E\x31\x39\x2E\x30\x2E\x31\x0A\x0D" //172.19.0.1
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\xB0\x68\xA4\xE5\xBC\xC6\xA5\xD8\x3A\x20\x30\x0A\x0D" //退文數目: 0
      "\x20\x20\x20\x20\x20\x20\x20\x20\xA4\x70\x20\xA4\xD1\x20\xA8\xCF\x3A" //        小 天 使:
      "\x20\xB5\x4C\x0A\x0D" // 無
      "\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x33\x30\x3B\x34\x31\x6D" //\x1b[30;41m
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72" //┴┬┴┬┴
      "\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┬┴┬┴┬
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72" //┴┬┴┬┴
      "\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┬┴┬┴┬
      "\xA2\x72\xA2\x73\xA2\x72\xA2\x73\xA2\x72" //┴┬┴┬┴
      "\xA2\x73\xA2\x72\xA2\x73\xA2\x72\xA2\x73" //┬┴┬┴┬
      "\x1B\x5B\x6D\x0A\x0D"
      "\xA8\xE4\xA5\xA6\xB8\xEA\xB0\x54\x3A\x20\x5B\xA5\xBC" //其它資訊: [未
      "\xB5\xF9\xA5\x55\x5D" //註冊]
      "\x1B\x5B\x32\x34\x3B\x31\x48\x1B\x5B\x30\x3B\x33\x34\x3B\x34\x36\x6D" //\x1b[24;18H\x1b0;34;46m
      "\x20\x20\xB7\x6A\xB4\x4D\xB1\x62\xB8\xB9\x20\x20" //  搜尋帳號
      "\x1B\x5B\x30\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[0;30;47m
      "\x20\x20\x1B\x5B\x30\x3B\x33\x31\x3B\x34\x37\x6D" //  \x1b[0;31;47m
      "\x28\xAA\xC5\xA5\xD5\xC1\xE4\x29" //(空白鍵)
      "\x1B\x5B\x30\x3B\x33\x30\x3B\x34\x37\x6D"
      "\xB7\x6A\xB4\x4D\xA4\x55\xA4\x40\xAD\xD3\x20" //搜尋下一個
      "\x1B\x5B\x30\x3B\x33\x31\x3B\x34\x37\x6D" //\x1b[0;31;47m
      "\x28\x41\x29" //(A)
      "\x1B\x5B\x30\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[0;30;47m
      "\xA5\x5B\xA4\x4A\xA6\x57\xB3\xE6\x20" //加入名單
      "\x1B\x5B\x30\x3B\x33\x31\x3B\x34\x37\x6D" //\x1b[0;31;47m
      "\x28\x46\x29" //(F)
      "\x1B\x5B\x30\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[0;30;47m
      "\xB7\x73\xBC\x57\xB1\xF8\xA5\xF3\x20" //新增條件
      "\x1B\x5B\x30\x3B\x33\x31\x3B\x34\x37\x6D" //\x1b[0;31;47m
      "\x28\x51\x29" //(Q)
      "\x1B\x5B\x30\x3B\x33\x30\x3B\x34\x37\x6D" //\x1b[0;30;47m
      "\xC2\xF7\xB6\x7D\x20\x20\x20\x20\x20" //離開
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x31\x33\x3B\x31\x48" //\x1b[m\x1b13;1H
      "\x20\x20\x28" //(  (
      "\x1B\x5B\x33\x36\x6D" //\x1b[36m
      "\x30" //0
      "\x1B\x5B\x6D"
      "\x29\x20\x20\x2E\x2E\x20" //)  ..
      "\x1B\x5B\x4B\x0A\x0D"
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x31\x1B\x5B\x6D\x29" //(\x1b[36m1\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x32\x1B\x5B\x6D\x29" //(\x1b[36m2\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x33\x1B\x5B\x6D\x29" //(\x1b[36m3\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x34\x1B\x5B\x6D\x29" //(\x1b[36m4\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x35\x1B\x5B\x6D\x29" //(\x1b[36m5\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x36\x1B\x5B\x6D\x29" //(\x1b[36m6\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x37\x1B\x5B\x6D\x29" //(\x1b[36m7\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x38\x1B\x5B\x6D\x29" //(\x1b[36m8\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\x20\x20\x28\x1B\x5B\x33\x36\x6D\x39\x1B\x5B\x6D\x29" //(\x1b[36m9\x1b[m)
      "\x20\x20\x2E\x2E\x20\x0A\x0D" //  ..
      "\xBD\xD0\xBF\xEF\xBE\xDC\xB2\xC4\xB4\x58\xB8\xB9\xAF\x53\xA7\x4F" //'請選擇第幾號特別
      "\xA6\x57\xB3\xE6\x20\x28\x30\x7E\x39\x29" //名單 (0~9)
      "\x5B\x30\x5D\x3F"  //[0]?
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x20\x20\x20\x1B\x5B\x6D\x1B\x5B\x32\x33\x3B\x33\x31\x48" //x1b[m\x1b[23;31H
      "\x1B\x5B\x33\x3B\x31\x48" //\x1b[3;1H
      "\xB4\x79\xAD\x7A\xA4\x40\xA4\x55\xA1\x47" //描述一下：
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x53\x59\x53\x4F\x50\x31\x30\x20\x20\x20\x20\x20\x20\x20\x20" //SYSOP10
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x4B\x1B\x5B\x33\x3B\x31\x38\x48\x0D" //\x1b[m\x1b[H\x1b[3;18H
      "\xB4\x79\xAD\x7A\xA4\x40\xA4\x55\xA1\x47" //描述一下：
      "\x1B\x5B\x30\x3B\x37\x6D" //\x1b[0;7m
      "\x53\x59\x53\x4F\x50\x31\x30\x30\x20\x20\x20\x20\x20\x20\x20" //SYSOP100
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20"
      "\x20\x20\x20\x20\x20"
      "\x1B\x5B\x6D\x1B\x5B\x33\x3B\x31\x39\x48\x0A\x0D" //\x1b[m\x1b[3;19H
      "\0";

  bzero(buf, sizeof(buf));
  memcpy(buf, expected + 932, 100);
  fprintf(stderr, "[admin_test4] buf: %s\n", buf);

  // XXX hack for (已滿 503 天)
  // 如果超過 1000 天: 在 expected 加上 \x30. 然後做 hack
  expected[932] = '0';
  expected[933] = '0';
  expected[934] = '0';

  OFLUSH_BUF[932] = '0';
  OFLUSH_BUF[933] = '0';
  OFLUSH_BUF[934] = '0';

  EXPECT_STREQ((char *)OFLUSH_BUF, (char *)expected);
}
